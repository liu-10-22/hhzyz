<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>海汇志愿者积分管理系统</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        /* 基础样式设置 */
        :root {
            --primary-color: #4CAF50;
            --primary-light: #E8F5E9;
            --secondary-color: #2196F3;
            --text-color: #333;
            --text-light: #666;
            --border-radius: 12px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif;
        }
        
        body {
            background-color: #f0f7f0; /* 淡绿色背景 */
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            min-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        /* 头部样式 */
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .logo {
            font-size: 28px;
            font-weight: 600;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .logo i {
            font-size: 32px;
        }
        
        /* 导航菜单 */
        nav {
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            overflow-x: auto;
        }
        
        .nav-menu {
            display: flex;
            list-style: none;
            padding: 0 20px;
        }
        
        .nav-menu li {
            flex-shrink: 0;
        }
        
        .nav-menu a {
            display: block;
            padding: 16px 20px;
            text-decoration: none;
            color: var(--text-light);
            font-weight: 500;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
        }
        
        .nav-menu a.active, 
        .nav-menu a:hover {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }
        
        /* 主内容区 */
        main {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .page {
            display: none;
            flex: 1;
        }
        
        .page.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 卡片设计 */
        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 25px;
            transition: var(--transition);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        
        .card-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* 表格样式 */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: var(--primary-light);
            font-weight: 600;
            color: var(--primary-color);
        }
        
        tr:hover {
            background-color: #f9f9f9;
        }
        
        /* 按钮样式 */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }
        
        .btn-danger {
            background-color: #f44336;
            color: white;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        /* 表单样式 */
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-light);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: var(--transition);
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
        }
        
        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 25px;
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        /* 登录页面 */
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 40px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
        }
        
        .login-title {
            margin-bottom: 30px;
            color: var(--primary-color);
        }
        
        .form-footer {
            margin-top: 20px;
            text-align: center;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                min-height: 100vh;
                border-radius: 0;
            }
            
            body {
                padding: 0;
            }
            
            .nav-menu {
                padding: 0;
            }
            
            .nav-menu a {
                padding: 14px 12px;
                font-size: 14px;
            }
            
            .card {
                padding: 20px 15px;
            }
            
            .modal-content {
                width: 95%;
                padding: 15px;
            }
        }
        
        /* 积分排行榜特殊样式 */
        .rank-badge {
            display: inline-block;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            border-radius: 50%;
            background-color: var(--primary-light);
            color: var(--primary-color);
            font-weight: bold;
            margin-right: 10px;
        }
        
        .rank-1 .rank-badge {
            background-color: gold;
            color: #333;
        }
        
        .rank-2 .rank-badge {
            background-color: silver;
            color: #333;
        }
        
        .rank-3 .rank-badge {
            background-color: #cd7f32;
            color: white;
        }
        
        .action-btns {
            display: flex;
            gap: 8px;
        }
        
        .action-btns .btn {
            padding: 8px 12px;
            font-size: 14px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 500;
        }
        
        /* 详情卡片样式 */
        .detail-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .detail-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .detail-item {
            margin-bottom: 15px;
        }
        
        .detail-label {
            font-weight: 500;
            color: var(--text-light);
            margin-bottom: 5px;
        }
        
        .detail-value {
            font-size: 16px;
        }
        
        .participants-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .participant-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        
        /* 添加项目/活动按钮 */
        .add-item-btn {
            margin-bottom: 20px;
        }
        
        /* 个人统计卡片 */
        .stats-card {
            display: flex;
            justify-content: space-around;
            text-align: center;
            margin-top: 30px;
        }
        
        .stat-item {
            flex: 1;
            padding: 20px;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }
        
        .stat-label {
            color: var(--text-light);
            font-size: 16px;
        }
    </style>
</head>
<body>
    <!-- 登录页面 -->
    <div id="loginPage" class="login-container">
        <h1 class="login-title">海汇志愿者积分系统</h1>
        <form id="loginForm">
            <div class="form-group">
                <label for="username">姓名</label>
                <input type="text" id="username" required>
            </div>
            <div class="form-group">
                <label for="password">密码</label>
                <input type="password" id="password" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width:100%;padding:14px;">登录</button>
        </form>
        <div class="form-footer">
            <p>没有账号？<a href="#" id="showRegister">注册新账号</a></p>
        </div>
    </div>

    <!-- 注册页面 -->
    <div id="registerPage" class="login-container" style="display:none;">
        <h1 class="login-title">志愿者注册</h1>
        <form id="registerForm">
            <div class="form-group">
                <label for="regName">姓名</label>
                <input type="text" id="regName" required>
            </div>
            <div class="form-group">
                <label for="regPassword">密码</label>
                <input type="password" id="regPassword" required>
            </div>
            <div class="form-group">
                <label for="regPhone">联系方式</label>
                <input type="tel" id="regPhone" required>
            </div>
            <div class="form-group">
                <label for="regAddress">家庭地址</label>
                <input type="text" id="regAddress" required>
            </div>
            <div class="form-group">
                <label for="regAge">年龄</label>
                <input type="number" id="regAge" required min="16" max="100">
            </div>
            <button type="submit" class="btn btn-primary" style="width:100%;padding:14px;">注册</button>
        </form>
        <div class="form-footer">
            <p>已有账号？<a href="#" id="showLogin">返回登录</a></p>
        </div>
    </div>

    <!-- 主系统 -->
    <div id="app" style="display:none;">
        <div class="container">
            <header>
                <div class="logo">
                    <i>🌱</i>海汇志愿者积分管理系统
                </div>
                <div style="position:absolute;right:20px;top:20px;">
                    <span id="currentUser"></span>
                    <button id="logoutBtn" class="btn btn-outline" style="margin-left:10px;">退出</button>
                </div>
            </header>
            
            <nav>
                <ul class="nav-menu">
                    <li><a href="#" data-page="dashboard" class="active">首页</a></li>
                    <li class="admin-only"><a href="#" data-page="volunteers">志愿者管理</a></li>
                    <li><a href="#" data-page="projects">志愿项目</a></li>
                    <li><a href="#" data-page="activities">社区活动</a></li>
                    <li class="admin-only"><a href="#" data-page="points">积分管理</a></li>
                    <li><a href="#" data-page="ranking">积分排行</a></li>
                    <li class="admin-only"><a href="#" data-page="importExport">导入导出</a></li>
                </ul>
            </nav>
            
            <main>
                <!-- 首页 -->
                <div id="dashboard" class="page active">
                    <div class="card">
                        <h2 class="card-title">欢迎使用志愿者积分系统</h2>
                        <p>海汇志愿者积分管理系统致力于帮助您高效管理志愿者信息和积分，激励志愿者参与社区服务。</p>
                        
                        <!-- 管理员首页统计 -->
                        <div id="adminStats" class="admin-only">
                            <div style="display:flex; gap:20px; margin-top:30px; flex-wrap:wrap;">
                                <div style="flex:1; min-width:250px; background:var(--primary-light); border-radius:var(--border-radius); padding:20px;">
                                    <h3>志愿者总数</h3>
                                    <p style="font-size:32px;font-weight:bold;margin:10px 0;" id="volunteerCount">0</p>
                                </div>
                                
                                <div style="flex:1; min-width:250px; background:var(--primary-light); border-radius:var(--border-radius); padding:20px;">
                                    <h3>活动总数</h3>
                                    <p style="font-size:32px;font-weight:bold;margin:10px 0;" id="activityCount">0</p>
                                </div>
                                
                                <div style="flex:1; min-width:250px; background:var(--primary-light); border-radius:var(--border-radius); padding:20px;">
                                    <h3>总积分</h3>
                                    <p style="font-size:32px;font-weight:bold;margin:10px 0;" id="totalPoints">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 普通用户个人统计 -->
                        <div id="userStats">
                            <div class="stats-card">
                                <div class="stat-item">
                                    <div class="stat-value" id="userProjectCount">0</div>
                                    <div class="stat-label">参与项目次数</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="userActivityCount">0</div>
                                    <div class="stat-label">参与活动次数</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="userPoints">0</div>
                                    <div class="stat-label">个人积分</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 管理员积分日志 -->
                    <div id="adminLogs" class="card admin-only">
                        <h2 class="card-title">最新积分动态</h2>
                        <div id="pointLogs" style="max-height:300px; overflow-y:auto;">
                            <!-- 积分日志将通过JS动态加载 -->
                        </div>
                    </div>
                </div>
                
                <!-- 志愿者管理 -->
                <div id="volunteers" class="page">
                    <div class="card">
                        <h2 class="card-title">志愿者管理</h2>
                        <button id="addVolunteerBtn" class="btn btn-primary">添加志愿者</button>
                        
                        <div style="margin-top:20px;">
                            <input type="text" id="volunteerSearch" placeholder="搜索志愿者..." style="padding:10px; width:300px; max-width:100%;">
                        </div>
                        
                        <table style="margin-top:20px;">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>姓名</th>
                                    <th>联系方式</th>
                                    <th>年龄</th>
                                    <th>当前积分</th>
                                    <th>管理员</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="volunteerList">
                                <!-- 志愿者列表将通过JS动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 志愿项目 -->
                <div id="projects" class="page">
                    <div class="card">
                        <h2 class="card-title">志愿项目</h2>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                            <p>以下是可参与的志愿项目，点击项目名称查看详情并报名。</p>
                            <button id="addProjectBtn" class="btn btn-primary admin-only">添加项目</button>
                        </div>
                        
                        <div id="projectList" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(300px, 1fr)); gap:20px; margin-top:20px;">
                            <!-- 项目列表将通过JS动态加载 -->
                        </div>
                    </div>
                </div>
                
                <!-- 社区活动 -->
                <div id="activities" class="page">
                    <div class="card">
                        <h2 class="card-title">社区活动</h2>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                            <p>参与社区活动需要消耗积分，报名即扣除相应积分。</p>
                            <button id="addActivityBtn" class="btn btn-primary admin-only">添加活动</button>
                        </div>
                        
                        <div id="activityList" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(300px, 1fr)); gap:20px; margin-top:20px;">
                            <!-- 活动列表将通过JS动态加载 -->
                        </div>
                    </div>
                </div>
                
                <!-- 积分管理 -->
                <div id="points" class="page">
                    <div class="tabs">
                        <div class="tab active" data-tab="adjustPoints">积分调整</div>
                        <div class="tab" data-tab="pointLog">积分日志</div>
                    </div>
                    
                    <div id="adjustPoints" class="tab-content active">
                        <div class="card">
                            <h2 class="card-title">积分调整</h2>
                            
                            <div class="form-group">
                                <label for="pointVolunteer">选择志愿者</label>
                                <select id="pointVolunteer">
                                    <!-- 志愿者选项将通过JS动态加载 -->
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="pointAction">操作类型</label>
                                <select id="pointAction">
                                    <option value="add">增加积分</option>
                                    <option value="subtract">扣除积分</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="pointAmount">积分数量</label>
                                <input type="number" id="pointAmount" min="1" value="10">
                            </div>
                            
                            <div class="form-group">
                                <label for="pointReason">原因说明</label>
                                <textarea id="pointReason" rows="3" placeholder="请输入调整积分的原因..."></textarea>
                            </div>
                            
                            <button id="adjustPointsBtn" class="btn btn-primary">执行调整</button>
                        </div>
                    </div>
                    
                    <div id="pointLog" class="tab-content">
                        <div class="card">
                            <h2 class="card-title">积分日志</h2>
                            
                            <div class="form-group">
                                <label for="logVolunteer">选择志愿者（可选）</label>
                                <select id="logVolunteer">
                                    <option value="">所有志愿者</option>
                                    <!-- 志愿者选项将通过JS动态加载 -->
                                </select>
                            </div>
                            
                            <table>
                                <thead>
                                    <tr>
                                        <th>时间</th>
                                        <th>志愿者</th>
                                        <th>操作</th>
                                        <th>积分变化</th>
                                        <th>原因</th>
                                        <th>操作人</th>
                                    </tr>
                                </thead>
                                <tbody id="pointLogList">
                                    <!-- 日志列表将通过JS动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- 积分排行 -->
                <div id="ranking" class="page">
                    <div class="card">
                        <h2 class="card-title">志愿者积分排行榜</h2>
                        
                        <div style="margin-bottom:20px;">
                            <button id="refreshRanking" class="btn btn-outline">刷新排行</button>
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>排名</th>
                                    <th>姓名</th>
                                    <th>积分</th>
                                    <th>参与项目</th>
                                    <th>参与活动</th>
                                </tr>
                            </thead>
                            <tbody id="rankingList">
                                <!-- 排行榜将通过JS动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 导入导出 -->
                <div id="importExport" class="page">
                    <div class="tabs">
                        <div class="tab active" data-tab="exportData">数据导出</div>
                        <div class="tab" data-tab="importData">数据导入</div>
                    </div>
                    
                    <div id="exportData" class="tab-content active">
                        <div class="card">
                            <h2 class="card-title">数据导出</h2>
                            <p>将系统数据导出为Excel文件：</p>
                            
                            <div style="display:flex; gap:15px; margin-top:20px; flex-wrap:wrap;">
                                <button id="exportVolunteers" class="btn btn-primary">导出志愿者数据</button>
                                <button id="exportProjects" class="btn btn-primary">导出项目数据</button>
                                <button id="exportActivities" class="btn btn-primary">导出活动数据</button>
                                <button id="exportPoints" class="btn btn-primary">导出积分日志</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="importData" class="tab-content">
                        <div class="card">
                            <h2 class="card-title">数据导入</h2>
                            <p>从Excel文件导入数据到系统：</p>
                            
                            <div class="form-group" style="margin-top:20px;">
                                <label for="importType">导入数据类型</label>
                                <select id="importType">
                                    <option value="volunteers">志愿者数据</option>
                                    <option value="projects">项目数据</option>
                                    <option value="activities">活动数据</option>
                                    <option value="points">积分日志</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="importFile">选择Excel文件</label>
                                <input type="file" id="importFile" accept=".xlsx, .xls">
                            </div>
                            
                            <button id="importBtn" class="btn btn-primary">导入数据</button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 志愿者编辑模态框 -->
    <div id="volunteerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">编辑志愿者信息</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="volunteerForm">
                <input type="hidden" id="editVolunteerId">
                <div class="form-group">
                    <label for="editName">姓名</label>
                    <input type="text" id="editName" required>
                </div>
                <div class="form-group">
                    <label for="editPassword">密码</label>
                    <input type="password" id="editPassword">
                </div>
                <div class="form-group">
                    <label for="editPhone">联系方式</label>
                    <input type="tel" id="editPhone" required>
                </div>
                <div class="form-group">
                    <label for="editAddress">家庭地址</label>
                    <input type="text" id="editAddress" required>
                </div>
                <div class="form-group">
                    <label for="editAge">年龄</label>
                    <input type="number" id="editAge" required min="16" max="100">
                </div>
                <div class="form-group">
                    <label for="editPoints">积分</label>
                    <input type="number" id="editPoints" required min="0">
                </div>
                <div class="form-group admin-only">
                    <label>
                        <input type="checkbox" id="editIsAdmin"> 设为管理员
                    </label>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline close-modal">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 项目编辑模态框 -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="projectModalTitle">添加志愿项目</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="projectForm">
                <input type="hidden" id="editProjectId">
                <div class="form-group">
                    <label for="editProjectName">项目名称</label>
                    <input type="text" id="editProjectName" required>
                </div>
                <div class="form-group">
                    <label for="editProjectDesc">项目描述</label>
                    <textarea id="editProjectDesc" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="editProjectLocation">地点</label>
                    <input type="text" id="editProjectLocation" required>
                </div>
                <div class="form-group">
                    <label for="editProjectDate">日期</label>
                    <input type="date" id="editProjectDate" required>
                </div>
                <div class="form-group">
                    <label for="editProjectMax">最大参与人数 (0表示无限制)</label>
                    <input type="number" id="editProjectMax" min="0" value="20">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline close-modal">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 活动编辑模态框 -->
    <div id="activityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="activityModalTitle">添加社区活动</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="activityForm">
                <input type="hidden" id="editActivityId">
                <div class="form-group">
                    <label for="editActivityName">活动名称</label>
                    <input type="text" id="editActivityName" required>
                </div>
                <div class="form-group">
                    <label for="editActivityDesc">活动描述</label>
                    <textarea id="editActivityDesc" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="editActivityLocation">地点</label>
                    <input type="text" id="editActivityLocation" required>
                </div>
                <div class="form-group">
                    <label for="editActivityDate">日期</label>
                    <input type="date" id="editActivityDate" required>
                </div>
                <div class="form-group">
                    <label for="editActivityPoints">所需积分</label>
                    <input type="number" id="editActivityPoints" min="1" value="20">
                </div>
                <div class="form-group">
                    <label for="editActivityMax">最大参与人数 (0表示无限制)</label>
                    <input type="number" id="editActivityMax" min="0" value="20">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline close-modal">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 项目详情模态框 -->
    <div id="projectDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="projectDetailTitle">项目详情</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="detail-card">
                <h4 class="detail-title" id="projectDetailName"></h4>
                <div class="detail-item">
                    <div class="detail-label">描述</div>
                    <div class="detail-value" id="projectDetailDesc"></div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">地点</div>
                    <div class="detail-value" id="projectDetailLocation"></div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">日期</div>
                    <div class="detail-value" id="projectDetailDate"></div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">参与人数</div>
                    <div class="detail-value" id="projectDetailParticipants"></div>
                </div>
                
                <div style="margin-top:20px;">
                    <button id="projectActionBtn" class="btn btn-primary" style="margin-right:10px;"></button>
                    <button class="btn btn-outline close-modal">关闭</button>
                </div>
                
                <div class="participants-list admin-only" style="margin-top:30px;">
                    <h4>报名人员</h4>
                    <div id="projectParticipantsList">
                        <!-- 参与者列表将通过JS动态加载 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 活动详情模态框 -->
    <div id="activityDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="activityDetailTitle">活动详情</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="detail-card">
                <h4 class="detail-title" id="activityDetailName"></h4>
                <div class="detail-item">
                    <div class="detail-label">描述</div>
                    <div class="detail-value" id="activityDetailDesc"></div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">地点</div>
                    <div class="detail-value" id="activityDetailLocation"></div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">日期</div>
                    <div class="detail-value" id="activityDetailDate"></div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">所需积分</div>
                    <div class="detail-value" id="activityDetailPoints"></div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">参与人数</div>
                    <div class="detail-value" id="activityDetailParticipants"></div>
                </div>
                
                <div style="margin-top:20px;">
                    <button id="activityActionBtn" class="btn btn-primary" style="margin-right:10px;"></button>
                    <button class="btn btn-outline close-modal">关闭</button>
                </div>
                
                <div class="participants-list admin-only" style="margin-top:30px;">
                    <h4>报名人员</h4>
                    <div id="activityParticipantsList">
                        <!-- 参与者列表将通过JS动态加载 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 初始数据
        const systemData = {
            // 管理员账户
            admin: {
                username: "admin",
                password: "admin123",
                isAdmin: true
            },
            
            // 初始志愿者数据
            volunteers: [
                {
                    id: 1,
                    name: "张三",
                    password: "123456",
                    phone: "13800138000",
                    address: "北京市朝阳区",
                    age: 28,
                    points: 120,
                    isAdmin: false
                },
                {
                    id: 2,
                    name: "李四",
                    password: "123456",
                    phone: "13900139000",
                    address: "上海市浦东新区",
                    age: 32,
                    points: 85,
                    isAdmin: false
                },
                {
                    id: 3,
                    name: "王五",
                    password: "123456",
                    phone: "13700137000",
                    address: "广州市天河区",
                    age: 25,
                    points: 150,
                    isAdmin: false
                }
            ],
            
            // 志愿项目
            projects: [
                {
                    id: 1,
                    name: "社区环保日",
                    description: "每月一次的社区环境清理活动，提高居民环保意识",
                    location: "社区公园",
                    date: "2025-08-15",
                    participants: [],
                    maxParticipants: 20
                },
                {
                    id: 2,
                    name: "敬老院志愿服务",
                    description: "为敬老院老人提供陪伴、理发、健康咨询等服务",
                    location: "阳光敬老院",
                    date: "2025-08-22",
                    participants: [],
                    maxParticipants: 15
                },
                {
                    id: 3,
                    name: "儿童图书馆助理",
                    description: "协助图书馆管理，帮助儿童借阅图书，组织阅读活动",
                    location: "市儿童图书馆",
                    date: "2025-08-10",
                    participants: [],
                    maxParticipants: 10
                }
            ],
            
            // 社区活动
            activities: [
                {
                    id: 1,
                    name: "公益讲座",
                    description: "邀请专家讲解健康养生知识",
                    location: "社区活动中心",
                    date: "2025-08-18",
                    pointsRequired: 20,
                    participants: [],
                    maxParticipants: 30
                },
                {
                    id: 2,
                    name: "手工艺工作坊",
                    description: "学习制作传统手工艺品",
                    location: "社区文化站",
                    date: "2025-08-25",
                    pointsRequired: 15,
                    participants: [],
                    maxParticipants: 20
                },
                {
                    id: 3,
                    name: "慈善义卖",
                    description: "义卖手工艺品，所得款项用于社区公益",
                    location: "社区广场",
                    date: "2025-09-01",
                    pointsRequired: 30,
                    participants: [],
                    maxParticipants: 50
                }
            ],
            
            // 积分日志
            pointLogs: [
                {
                    id: 1,
                    volunteerId: 1,
                    action: "add",
                    points: 50,
                    reason: "初始积分",
                    admin: "system",
                    timestamp: new Date().toISOString()
                },
                {
                    id: 2,
                    volunteerId: 2,
                    action: "add",
                    points: 50,
                    reason: "初始积分",
                    admin: "system",
                    timestamp: new Date().toISOString()
                },
                {
                    id: 3,
                    volunteerId: 3,
                    action: "add",
                    points: 50,
                    reason: "初始积分",
                    admin: "system",
                    timestamp: new Date().toISOString()
                },
                {
                    id: 4,
                    volunteerId: 1,
                    action: "add",
                    points: 30,
                    reason: "参与社区环保日活动",
                    admin: "admin",
                    timestamp: new Date().toISOString()
                },
                {
                    id: 5,
                    volunteerId: 3,
                    action: "add",
                    points: 40,
                    reason: "敬老院志愿服务",
                    admin: "admin",
                    timestamp: new Date().toISOString()
                },
                {
                    id: 6,
                    volunteerId: 2,
                    action: "add",
                    points: 35,
                    reason: "儿童图书馆助理",
                    admin: "admin",
                    timestamp: new Date().toISOString()
                }
            ]
        };
        
        // 当前登录用户
        let currentUser = null;
        
        // DOM 加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化数据
            initData();
            
            // 登录表单事件
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // 注册表单事件
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            
            // 切换登录/注册页面
            document.getElementById('showRegister').addEventListener('click', showRegisterPage);
            document.getElementById('showLogin').addEventListener('click', showLoginPage);
            
            // 退出登录
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // 导航菜单点击事件
            document.querySelectorAll('.nav-menu a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage(link.dataset.page);
                    
                    // 更新活动菜单项
                    document.querySelectorAll('.nav-menu a').forEach(item => {
                        item.classList.remove('active');
                    });
                    link.classList.add('active');
                });
            });
            
            // 标签页切换
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.dataset.tab;
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // 添加志愿者按钮
            document.getElementById('addVolunteerBtn').addEventListener('click', () => {
                showRegisterPage();
                document.getElementById('app').style.display = 'none';
                document.getElementById('registerPage').style.display = 'block';
            });
            
            // 积分调整
            document.getElementById('adjustPointsBtn').addEventListener('click', adjustPoints);
            
            // 刷新排行榜
            document.getElementById('refreshRanking').addEventListener('click', loadRanking);
            
            // 数据导出按钮
            document.getElementById('exportVolunteers').addEventListener('click', () => exportData('volunteers'));
            document.getElementById('exportProjects').addEventListener('click', () => exportData('projects'));
            document.getElementById('exportActivities').addEventListener('click', () => exportData('activities'));
            document.getElementById('exportPoints').addEventListener('click', () => exportData('points'));
            
            // 数据导入
            document.getElementById('importBtn').addEventListener('click', importData);
            
            // 添加项目按钮
            document.getElementById('addProjectBtn').addEventListener('click', () => showProjectModal());
            
            // 添加活动按钮
            document.getElementById('addActivityBtn').addEventListener('click', () => showActivityModal());
            
            // 志愿者表单提交
            document.getElementById('volunteerForm').addEventListener('submit', saveVolunteer);
            
            // 项目表单提交
            document.getElementById('projectForm').addEventListener('submit', saveProject);
            
            // 活动表单提交
            document.getElementById('activityForm').addEventListener('submit', saveActivity);
            
            // 日志志愿者选择变化
            document.getElementById('logVolunteer').addEventListener('change', loadPointLogTable);
            
            // 关闭模态框按钮
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                });
            });
            
            // 点击模态框外部关闭
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });
        });
        
        // 初始化数据
        function initData() {
            // 尝试从 localStorage 加载数据
            const savedData = localStorage.getItem('volunteerSystemData');
            if (savedData) {
                try {
                    Object.assign(systemData, JSON.parse(savedData));
                } catch (e) {
                    console.error('Failed to parse saved data', e);
                }
            }
            
            // 确保初始管理员存在
            if (!systemData.volunteers.some(v => v.name === systemData.admin.username)) {
                systemData.volunteers.push({
                    id: generateId(systemData.volunteers),
                    name: systemData.admin.username,
                    password: systemData.admin.password,
                    phone: "",
                    address: "",
                    age: 0,
                    points: 0,
                    isAdmin: true
                });
            }
        }
        
        // 保存数据到 localStorage
        function saveData() {
            localStorage.setItem('volunteerSystemData', JSON.stringify(systemData));
        }
        
        // 处理登录
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // 检查管理员登录
            if (username === systemData.admin.username && password === systemData.admin.password) {
                currentUser = {
                    name: username,
                    isAdmin: true
                };
                showMainApp();
                return;
            }
            
            // 检查志愿者登录
            const volunteer = systemData.volunteers.find(v => v.name === username && v.password === password);
            if (volunteer) {
                currentUser = {
                    id: volunteer.id,
                    name: volunteer.name,
                    isAdmin: !!volunteer.isAdmin
                };
                showMainApp();
                return;
            }
            
            alert('用户名或密码错误');
        }
        
        // 处理注册
        function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('regName').value;
            const password = document.getElementById('regPassword').value;
            const phone = document.getElementById('regPhone').value;
            const address = document.getElementById('regAddress').value;
            const age = parseInt(document.getElementById('regAge').value);
            
            // 检查是否已存在同名志愿者
            if (systemData.volunteers.some(v => v.name === name)) {
                alert('该姓名已注册，请使用其他姓名');
                return;
            }
            
            // 创建新志愿者
            const newVolunteer = {
                id: generateId(systemData.volunteers),
                name,
                password,
                phone,
                address,
                age,
                points: 0,
                isAdmin: false
            };
            
            systemData.volunteers.push(newVolunteer);
            saveData();
            
            // 添加初始积分日志
            systemData.pointLogs.push({
                id: generateId(systemData.pointLogs),
                volunteerId: newVolunteer.id,
                action: "add",
                points: 0,
                reason: "新用户注册",
                admin: "system",
                timestamp: new Date().toISOString()
            });
            
            alert('注册成功！请登录');
            showLoginPage();
        }
        
        // 生成唯一ID
        function generateId(array) {
            return array.length > 0 ? Math.max(...array.map(item => item.id)) + 1 : 1;
        }
        
        // 显示注册页面
        function showRegisterPage(e) {
            if (e) e.preventDefault();
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('registerPage').style.display = 'block';
            
            // 清空表单
            document.getElementById('regName').value = '';
            document.getElementById('regPassword').value = '';
            document.getElementById('regPhone').value = '';
            document.getElementById('regAddress').value = '';
            document.getElementById('regAge').value = '';
        }
        
        // 显示登录页面
        function showLoginPage(e) {
            if (e) e.preventDefault();
            document.getElementById('registerPage').style.display = 'none';
            document.getElementById('loginPage').style.display = 'block';
            
            // 清空表单
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }
        
        // 显示主应用
        function showMainApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('registerPage').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            
            // 更新当前用户显示
            document.getElementById('currentUser').textContent = `欢迎, ${currentUser.name}${currentUser.isAdmin ? ' (管理员)' : ''}`;
            
            // 根据权限显示/隐藏管理员菜单项
            document.querySelectorAll('.admin-only').forEach(item => {
                item.style.display = currentUser.isAdmin ? 'block' : 'none';
            });
            
            // 根据权限显示/隐藏首页内容
            document.getElementById('adminStats').style.display = currentUser.isAdmin ? 'block' : 'none';
            document.getElementById('adminLogs').style.display = currentUser.isAdmin ? 'block' : 'none';
            document.getElementById('userStats').style.display = currentUser.isAdmin ? 'none' : 'block';
            
            // 加载首页数据
            showPage('dashboard');
            
            // 更新统计数据
            updateDashboardStats();
            
            // 加载积分日志
            loadPointLogs();
            
            // 加载个人统计数据
            loadUserStats();
        }
        
        // 更新仪表板统计数据
        function updateDashboardStats() {
            if (!currentUser.isAdmin) return;
            
            document.getElementById('volunteerCount').textContent = systemData.volunteers.filter(v => !v.isAdmin).length;
            document.getElementById('activityCount').textContent = systemData.activities.length;
            document.getElementById('totalPoints').textContent = systemData.volunteers.reduce((sum, v) => sum + v.points, 0);
        }
        
        // 加载个人统计数据
        function loadUserStats() {
            if (currentUser.isAdmin) return;
            
            const volunteer = systemData.volunteers.find(v => v.id === currentUser.id);
            if (!volunteer) return;
            
            // 计算参与项目次数
            const projectCount = systemData.projects.reduce((count, project) => {
                return count + (project.participants.some(p => p.volunteerId === currentUser.id) ? 1 : 0);
            }, 0);
            
            // 计算参与活动次数
            const activityCount = systemData.activities.reduce((count, activity) => {
                return count + (activity.participants.some(p => p.volunteerId === currentUser.id) ? 1 : 0);
            }, 0);
            
            // 更新显示
            document.getElementById('userProjectCount').textContent = projectCount;
            document.getElementById('userActivityCount').textContent = activityCount;
            document.getElementById('userPoints').textContent = volunteer.points;
        }
        
        // 显示指定页面
        function showPage(pageId) {
            // 隐藏所有页面
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // 显示请求的页面
            document.getElementById(pageId).classList.add('active');
            
            // 加载页面特定数据
            switch (pageId) {
                case 'volunteers':
                    loadVolunteers();
                    break;
                case 'projects':
                    loadProjects();
                    break;
                case 'activities':
                    loadActivities();
                    break;
                case 'points':
                    loadPointManagement();
                    break;
                case 'ranking':
                    loadRanking();
                    break;
                case 'dashboard':
                    loadDashboard();
                    break;
            }
        }
        
        // 加载志愿者列表
function loadVolunteers() {
    const volunteerList = document.getElementById('volunteerList');
    volunteerList.innerHTML = '';
    
    systemData.volunteers.forEach(volunteer => {
        // 不显示当前登录的管理员自己（避免自己删除自己）
        if (volunteer.name === currentUser.name) return;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${volunteer.id}</td>
            <td>${volunteer.name} ${volunteer.isAdmin ? '<span style="color:var(--primary-color);">(管理员)</span>' : ''}</td>
            <td>${volunteer.phone}</td>
            <td>${volunteer.age}</td>
            <td>${volunteer.points}</td>
            <td>${volunteer.isAdmin ? '是' : '否'}</td>
            <td class="action-btns">
                <button class="btn btn-outline edit-volunteer" data-id="${volunteer.id}">编辑</button>
                ${!volunteer.isAdmin ? `<button class="btn btn-danger delete-volunteer" data-id="${volunteer.id}">删除</button>` : ''}
                ${!volunteer.isAdmin ? `<button class="btn btn-secondary set-admin" data-id="${volunteer.id}">设为管理员</button>` : ''}
            </td>
        `;
        volunteerList.appendChild(row);
    });
    
    // 添加编辑事件
    document.querySelectorAll('.edit-volunteer').forEach(btn => {
        btn.addEventListener('click', () => editVolunteer(parseInt(btn.dataset.id)));
    });
    
    // 添加删除事件
    document.querySelectorAll('.delete-volunteer').forEach(btn => {
        btn.addEventListener('click', () => deleteVolunteer(parseInt(btn.dataset.id)));
    });
    
    // 添加设为管理员事件
    document.querySelectorAll('.set-admin').forEach(btn => {
        btn.addEventListener('click', () => setAsAdmin(parseInt(btn.dataset.id)));
    });
}

// 设为管理员函数
function setAsAdmin(id) {
    if (!confirm('确定要将此志愿者设为管理员吗？管理员拥有系统管理权限。')) return;
    
    const volunteer = systemData.volunteers.find(v => v.id === id);
    if (!volunteer) return;
    
    volunteer.isAdmin = true;
    saveData();
    
    alert('已成功设置为管理员');
    loadVolunteers();
}

// 编辑志愿者函数保持不变，但确保管理员可以编辑其他管理员的信息
function editVolunteer(id) {
    const volunteer = systemData.volunteers.find(v => v.id === id);
    if (!volunteer) return;
    
    // 填充表单
    document.getElementById('editVolunteerId').value = volunteer.id;
    document.getElementById('editName').value = volunteer.name;
    document.getElementById('editPhone').value = volunteer.phone;
    document.getElementById('editAddress').value = volunteer.address;
    document.getElementById('editAge').value = volunteer.age;
    document.getElementById('editPoints').value = volunteer.points;
    document.getElementById('editIsAdmin').checked = !!volunteer.isAdmin;
    
    // 显示模态框
    document.getElementById('volunteerModal').style.display = 'flex';
}        
        // 保存志愿者信息
        function saveVolunteer(e) {
            e.preventDefault();
            
            const id = parseInt(document.getElementById('editVolunteerId').value);
            const name = document.getElementById('editName').value;
            const password = document.getElementById('editPassword').value;
            const phone = document.getElementById('editPhone').value;
            const address = document.getElementById('editAddress').value;
            const age = parseInt(document.getElementById('editAge').value);
            const points = parseInt(document.getElementById('editPoints').value);
            const isAdmin = document.getElementById('editIsAdmin').checked;
            
            const volunteer = systemData.volunteers.find(v => v.id === id);
            if (!volunteer) return;
            
            // 更新信息
            volunteer.name = name;
            if (password) volunteer.password = password;
            volunteer.phone = phone;
            volunteer.address = address;
            volunteer.age = age;
            volunteer.points = points;
            volunteer.isAdmin = isAdmin;
            
            saveData();
            
            // 关闭模态框
            document.getElementById('volunteerModal').style.display = 'none';
            
            // 刷新列表
            loadVolunteers();
            updateDashboardStats();
            loadUserStats();
        }
        
        // 删除志愿者
        function deleteVolunteer(id) {
            if (!confirm('确定要删除这个志愿者吗？此操作不可恢复。')) return;
            
            systemData.volunteers = systemData.volunteers.filter(v => v.id !== id);
            
            // 删除相关积分日志
            systemData.pointLogs = systemData.pointLogs.filter(log => log.volunteerId !== id);
            
            // 从项目和活动中删除参与者
            systemData.projects.forEach(project => {
                project.participants = project.participants.filter(p => p.volunteerId !== id);
            });
            
            systemData.activities.forEach(activity => {
                activity.participants = activity.participants.filter(p => p.volunteerId !== id);
            });
            
            saveData();
            loadVolunteers();
            updateDashboardStats();
        }
        
        // 显示项目模态框
        function showProjectModal(projectId) {
            const modal = document.getElementById('projectModal');
            const title = document.getElementById('projectModalTitle');
            
            if (projectId) {
                // 编辑现有项目
                const project = systemData.projects.find(p => p.id === projectId);
                if (!project) return;
                
                title.textContent = '编辑志愿项目';
                document.getElementById('editProjectId').value = project.id;
                document.getElementById('editProjectName').value = project.name;
                document.getElementById('editProjectDesc').value = project.description;
                document.getElementById('editProjectLocation').value = project.location;
                document.getElementById('editProjectDate').value = project.date;
                document.getElementById('editProjectMax').value = project.maxParticipants;
            } else {
                // 添加新项目
                title.textContent = '添加志愿项目';
                document.getElementById('editProjectId').value = '';
                document.getElementById('editProjectName').value = '';
                document.getElementById('editProjectDesc').value = '';
                document.getElementById('editProjectLocation').value = '';
                document.getElementById('editProjectDate').value = '';
                document.getElementById('editProjectMax').value = '20';
            }
            
            modal.style.display = 'flex';
        }
        
        // 保存项目
        function saveProject(e) {
            e.preventDefault();
            
            const id = document.getElementById('editProjectId').value 
                ? parseInt(document.getElementById('editProjectId').value)
                : generateId(systemData.projects);
            
            const name = document.getElementById('editProjectName').value;
            const description = document.getElementById('editProjectDesc').value;
            const location = document.getElementById('editProjectLocation').value;
            const date = document.getElementById('editProjectDate').value;
            const maxParticipants = parseInt(document.getElementById('editProjectMax').value);
            
            const existingIndex = systemData.projects.findIndex(p => p.id === id);
            
            const projectData = {
                id,
                name,
                description,
                location,
                date,
                maxParticipants,
                participants: existingIndex !== -1 ? systemData.projects[existingIndex].participants : []
            };
            
            if (existingIndex !== -1) {
                // 更新现有项目
                systemData.projects[existingIndex] = projectData;
            } else {
                // 添加新项目
                systemData.projects.push(projectData);
            }
            
            saveData();
            document.getElementById('projectModal').style.display = 'none';
            loadProjects();
        }
        
        // 显示活动模态框
        function showActivityModal(activityId) {
            const modal = document.getElementById('activityModal');
            const title = document.getElementById('activityModalTitle');
            
            if (activityId) {
                // 编辑现有活动
                const activity = systemData.activities.find(a => a.id === activityId);
                if (!activity) return;
                
                title.textContent = '编辑社区活动';
                document.getElementById('editActivityId').value = activity.id;
                document.getElementById('editActivityName').value = activity.name;
                document.getElementById('editActivityDesc').value = activity.description;
                document.getElementById('editActivityLocation').value = activity.location;
                document.getElementById('editActivityDate').value = activity.date;
                document.getElementById('editActivityPoints').value = activity.pointsRequired;
                document.getElementById('editActivityMax').value = activity.maxParticipants;
            } else {
                // 添加新活动
                title.textContent = '添加社区活动';
                document.getElementById('editActivityId').value = '';
                document.getElementById('editActivityName').value = '';
                document.getElementById('editActivityDesc').value = '';
                document.getElementById('editActivityLocation').value = '';
                document.getElementById('editActivityDate').value = '';
                document.getElementById('editActivityPoints').value = '20';
                document.getElementById('editActivityMax').value = '30';
            }
            
            modal.style.display = 'flex';
        }
        
        // 保存活动
        function saveActivity(e) {
            e.preventDefault();
            
            const id = document.getElementById('editActivityId').value 
                ? parseInt(document.getElementById('editActivityId').value)
                : generateId(systemData.activities);
            
            const name = document.getElementById('editActivityName').value;
            const description = document.getElementById('editActivityDesc').value;
            const location = document.getElementById('editActivityLocation').value;
            const date = document.getElementById('editActivityDate').value;
            const pointsRequired = parseInt(document.getElementById('editActivityPoints').value);
            const maxParticipants = parseInt(document.getElementById('editActivityMax').value);
            
            const existingIndex = systemData.activities.findIndex(a => a.id === id);
            
            const activityData = {
                id,
                name,
                description,
                location,
                date,
                pointsRequired,
                maxParticipants,
                participants: existingIndex !== -1 ? systemData.activities[existingIndex].participants : []
            };
            
            if (existingIndex !== -1) {
                // 更新现有活动
                systemData.activities[existingIndex] = activityData;
            } else {
                // 添加新活动
                systemData.activities.push(activityData);
            }
            
            saveData();
            document.getElementById('activityModal').style.display = 'none';
            loadActivities();
        }
        
        // 加载志愿项目
        function loadProjects() {
            const projectList = document.getElementById('projectList');
            projectList.innerHTML = '';
            
            systemData.projects.forEach(project => {
                const isParticipating = project.participants.some(p => p.volunteerId === currentUser.id);
                const availableSpots = project.maxParticipants > 0 
                    ? `${project.maxParticipants - project.participants.length}/${project.maxParticipants}`
                    : '无限制';
                
                const projectCard = document.createElement('div');
                projectCard.className = 'card';
                projectCard.innerHTML = `
                    <h3>${project.name}</h3>
                    <p>${project.description}</p>
                    <p><strong>地点:</strong> ${project.location}</p>
                    <p><strong>时间:</strong> ${project.date}</p>
                    <p><strong>名额:</strong> ${availableSpots}</p>
                    <div style="margin-top:15px;">
                        <button class="btn ${isParticipating ? 'btn-outline' : 'btn-primary'} project-action" 
                                data-id="${project.id}">
                            ${isParticipating ? '取消报名' : '报名参加'}
                        </button>
                        <button class="btn btn-outline view-project-details" data-id="${project.id}">查看详情</button>
                        ${currentUser.isAdmin ? `<button class="btn btn-outline edit-project" data-id="${project.id}" style="margin-left:5px;">编辑</button>` : ''}
                        ${currentUser.isAdmin ? `<button class="btn btn-danger delete-project" data-id="${project.id}" style="margin-left:5px;">删除</button>` : ''}
                    </div>
                `;
                projectList.appendChild(projectCard);
            });
            
            // 添加报名事件
            document.querySelectorAll('.project-action').forEach(btn => {
                btn.addEventListener('click', () => toggleProjectParticipation(parseInt(btn.dataset.id)));
            });
            
            // 添加查看详情事件
            document.querySelectorAll('.view-project-details').forEach(btn => {
                btn.addEventListener('click', () => showProjectDetails(parseInt(btn.dataset.id)));
            });
            
            // 添加编辑事件
            document.querySelectorAll('.edit-project').forEach(btn => {
                btn.addEventListener('click', () => showProjectModal(parseInt(btn.dataset.id)));
            });
            
            // 添加删除事件
            document.querySelectorAll('.delete-project').forEach(btn => {
                btn.addEventListener('click', () => deleteProject(parseInt(btn.dataset.id)));
            });
        }
        
        // 显示项目详情
        function showProjectDetails(projectId) {
            const project = systemData.projects.find(p => p.id === projectId);
            if (!project) return;
            
            const isParticipating = project.participants.some(p => p.volunteerId === currentUser.id);
            
            // 填充详情
            document.getElementById('projectDetailTitle').textContent = project.name;
            document.getElementById('projectDetailName').textContent = project.name;
            document.getElementById('projectDetailDesc').textContent = project.description;
            document.getElementById('projectDetailLocation').textContent = project.location;
            document.getElementById('projectDetailDate').textContent = project.date;
            document.getElementById('projectDetailParticipants').textContent = 
                project.maxParticipants > 0 
                    ? `${project.participants.length}/${project.maxParticipants}`
                    : `${project.participants.length} (无限制)`;
            
            // 设置报名/取消报名按钮
            const actionBtn = document.getElementById('projectActionBtn');
            actionBtn.textContent = isParticipating ? '取消报名' : '报名参加';
            actionBtn.onclick = () => {
                toggleProjectParticipation(projectId);
                document.getElementById('projectDetailModal').style.display = 'none';
            };
            
            // 加载参与者列表
            const participantsList = document.getElementById('projectParticipantsList');
            participantsList.innerHTML = '';
            
            project.participants.forEach(participant => {
                const volunteer = systemData.volunteers.find(v => v.id === participant.volunteerId);
                if (!volunteer) return;
                
                const participantItem = document.createElement('div');
                participantItem.className = 'participant-item';
                participantItem.innerHTML = `
                    <span>${volunteer.name}</span>
                    <span>${new Date(participant.date).toLocaleDateString()}</span>
                `;
                participantsList.appendChild(participantItem);
            });
            
            // 显示模态框
            document.getElementById('projectDetailModal').style.display = 'flex';
        }
        
        // 报名/取消报名项目
        function toggleProjectParticipation(projectId) {
            const project = systemData.projects.find(p => p.id === projectId);
            if (!project) return;
            
            const participantIndex = project.participants.findIndex(p => p.volunteerId === currentUser.id);
            
            if (participantIndex !== -1) {
                // 取消报名
                project.participants.splice(participantIndex, 1);
            } else {
                // 报名
                if (project.maxParticipants > 0 && project.participants.length >= project.maxParticipants) {
                    alert('该项目名额已满');
                    return;
                }
                
                project.participants.push({
                    volunteerId: currentUser.id,
                    name: currentUser.name,
                    date: new Date().toISOString()
                });
            }
            
            saveData();
            loadProjects();
            loadUserStats();
        }
        
        // 删除项目
        function deleteProject(projectId) {
            if (!confirm('确定要删除这个项目吗？所有报名信息也将被删除。')) return;
            
            systemData.projects = systemData.projects.filter(p => p.id !== projectId);
            saveData();
            loadProjects();
        }
        
        // 加载社区活动
        function loadActivities() {
            const activityList = document.getElementById('activityList');
            activityList.innerHTML = '';
            
            systemData.activities.forEach(activity => {
                const isParticipating = activity.participants.some(p => p.volunteerId === currentUser.id);
                const volunteer = systemData.volunteers.find(v => v.id === currentUser.id);
                const canJoin = volunteer && volunteer.points >= activity.pointsRequired;
                const availableSpots = activity.maxParticipants > 0 
                    ? `${activity.maxParticipants - activity.participants.length}/${activity.maxParticipants}`
                    : '无限制';
                
                const activityCard = document.createElement('div');
                activityCard.className = 'card';
                activityCard.innerHTML = `
                    <h3>${activity.name}</h3>
                    <p>${activity.description}</p>
                    <p><strong>地点:</strong> ${activity.location}</p>
                    <p><strong>时间:</strong> ${activity.date}</p>
                    <p><strong>所需积分:</strong> ${activity.pointsRequired}</p>
                    <p><strong>名额:</strong> ${availableSpots}</p>
                    <div style="margin-top:15px;">
                        <button class="btn ${isParticipating ? 'btn-outline' : (canJoin ? 'btn-primary' : 'btn-outline')} activity-action" 
                                data-id="${activity.id}" ${!canJoin && !isParticipating ? 'disabled' : ''}>
                            ${isParticipating ? '取消报名' : '报名参加'}
                        </button>
                        <button class="btn btn-outline view-activity-details" data-id="${activity.id}">查看详情</button>
                        ${currentUser.isAdmin ? `<button class="btn btn-outline edit-activity" data-id="${activity.id}" style="margin-left:5px;">编辑</button>` : ''}
                        ${currentUser.isAdmin ? `<button class="btn btn-danger delete-activity" data-id="${activity.id}" style="margin-left:5px;">删除</button>` : ''}
                    </div>
                    ${!canJoin && !isParticipating ? `<p style="color:#f44336;margin-top:10px;">积分不足，无法报名</p>` : ''}
                `;
                activityList.appendChild(activityCard);
            });
            
            // 添加报名事件
            document.querySelectorAll('.activity-action').forEach(btn => {
                if (!btn.disabled) {
                    btn.addEventListener('click', () => toggleActivityParticipation(parseInt(btn.dataset.id)));
                }
            });
            
            // 添加查看详情事件
            document.querySelectorAll('.view-activity-details').forEach(btn => {
                btn.addEventListener('click', () => showActivityDetails(parseInt(btn.dataset.id)));
            });
            
            // 添加编辑事件
            document.querySelectorAll('.edit-activity').forEach(btn => {
                btn.addEventListener('click', () => showActivityModal(parseInt(btn.dataset.id)));
            });
            
            // 添加删除事件
            document.querySelectorAll('.delete-activity').forEach(btn => {
                btn.addEventListener('click', () => deleteActivity(parseInt(btn.dataset.id)));
            });
        }
        
        // 显示活动详情
        function showActivityDetails(activityId) {
            const activity = systemData.activities.find(a => a.id === activityId);
            if (!activity) return;
            
            const isParticipating = activity.participants.some(p => p.volunteerId === currentUser.id);
            const volunteer = systemData.volunteers.find(v => v.id === currentUser.id);
            const canJoin = volunteer && volunteer.points >= activity.pointsRequired;
            
            // 填充详情
            document.getElementById('activityDetailTitle').textContent = activity.name;
            document.getElementById('activityDetailName').textContent = activity.name;
            document.getElementById('activityDetailDesc').textContent = activity.description;
            document.getElementById('activityDetailLocation').textContent = activity.location;
            document.getElementById('activityDetailDate').textContent = activity.date;
            document.getElementById('activityDetailPoints').textContent = activity.pointsRequired;
            document.getElementById('activityDetailParticipants').textContent = 
                activity.maxParticipants > 0 
                    ? `${activity.participants.length}/${activity.maxParticipants}`
                    : `${activity.participants.length} (无限制)`;
            
            // 设置报名/取消报名按钮
            const actionBtn = document.getElementById('activityActionBtn');
            actionBtn.textContent = isParticipating ? '取消报名' : '报名参加';
            actionBtn.disabled = !isParticipating && !canJoin;
            actionBtn.onclick = () => {
                toggleActivityParticipation(activityId);
                document.getElementById('activityDetailModal').style.display = 'none';
            };
            
            // 加载参与者列表
            const participantsList = document.getElementById('activityParticipantsList');
            participantsList.innerHTML = '';
            
            activity.participants.forEach(participant => {
                const volunteer = systemData.volunteers.find(v => v.id === participant.volunteerId);
                if (!volunteer) return;
                
                const participantItem = document.createElement('div');
                participantItem.className = 'participant-item';
                participantItem.innerHTML = `
                    <span>${volunteer.name}</span>
                    <span>${new Date(participant.date).toLocaleDateString()}</span>
                `;
                participantsList.appendChild(participantItem);
            });
            
            // 显示模态框
            document.getElementById('activityDetailModal').style.display = 'flex';
        }
        
        // 报名/取消报名活动
        function toggleActivityParticipation(activityId) {
            const activity = systemData.activities.find(a => a.id === activityId);
            if (!activity) return;
            
            const volunteer = systemData.volunteers.find(v => v.id === currentUser.id);
            if (!volunteer) return;
            
            const participantIndex = activity.participants.findIndex(p => p.volunteerId === currentUser.id);
            
            if (participantIndex !== -1) {
                // 取消报名 - 退还积分
                activity.participants.splice(participantIndex, 1);
                volunteer.points += activity.pointsRequired;
                
                // 添加积分日志
                systemData.pointLogs.push({
                    id: generateId(systemData.pointLogs),
                    volunteerId: currentUser.id,
                    action: "add",
                    points: activity.pointsRequired,
                    reason: `取消活动报名: ${activity.name}`,
                    admin: "system",
                    timestamp: new Date().toISOString()
                });
            } else {
                // 报名 - 扣除积分
                if (volunteer.points < activity.pointsRequired) {
                    alert('您的积分不足，无法报名此活动');
                    return;
                }
                
                if (activity.maxParticipants > 0 && activity.participants.length >= activity.maxParticipants) {
                    alert('该活动名额已满');
                    return;
                }
                
                activity.participants.push({
                    volunteerId: currentUser.id,
                    name: currentUser.name,
                    date: new Date().toISOString()
                });
                
                volunteer.points -= activity.pointsRequired;
                
                // 添加积分日志
                systemData.pointLogs.push({
                    id: generateId(systemData.pointLogs),
                    volunteerId: currentUser.id,
                    action: "subtract",
                    points: activity.pointsRequired,
                    reason: `报名活动: ${activity.name}`,
                    admin: "system",
                    timestamp: new Date().toISOString()
                });
            }
            
            saveData();
            loadActivities();
            loadUserStats();
        }
        
        // 删除活动
        function deleteActivity(activityId) {
            if (!confirm('确定要删除这个活动吗？所有报名信息也将被删除。')) return;
            
            systemData.activities = systemData.activities.filter(a => a.id !== activityId);
            saveData();
            loadActivities();
        }
        
        // 加载积分管理页面
        function loadPointManagement() {
            // 更新志愿者下拉列表
            const volunteerSelect = document.getElementById('pointVolunteer');
            volunteerSelect.innerHTML = '';
            
            systemData.volunteers.forEach(volunteer => {
                if (volunteer.isAdmin) return;
                
                const option = document.createElement('option');
                option.value = volunteer.id;
                option.textContent = `${volunteer.name} (当前积分: ${volunteer.points})`;
                volunteerSelect.appendChild(option);
            });
            
            // 更新日志志愿者下拉列表
            const logVolunteerSelect = document.getElementById('logVolunteer');
            logVolunteerSelect.innerHTML = '<option value="">所有志愿者</option>';
            
            systemData.volunteers.forEach(volunteer => {
                if (volunteer.isAdmin) return;
                
                const option = document.createElement('option');
                option.value = volunteer.id;
                option.textContent = volunteer.name;
                logVolunteerSelect.appendChild(option);
            });
            
            // 加载积分日志
            loadPointLogTable();
        }
        
        // 调整积分
        function adjustPoints() {
            const volunteerId = parseInt(document.getElementById('pointVolunteer').value);
            const action = document.getElementById('pointAction').value;
            const points = parseInt(document.getElementById('pointAmount').value);
            const reason = document.getElementById('pointReason').value.trim();
            
            if (!volunteerId || isNaN(points) || points <= 0 || !reason) {
                alert('请填写完整信息');
                return;
            }
            
            const volunteer = systemData.volunteers.find(v => v.id === volunteerId);
            if (!volunteer) return;
            
            // 执行积分调整
            if (action === 'add') {
                volunteer.points += points;
            } else {
                if (volunteer.points < points) {
                    alert('志愿者积分不足，无法扣除');
                    return;
                }
                volunteer.points -= points;
            }
            
            // 添加积分日志
            systemData.pointLogs.push({
                id: generateId(systemData.pointLogs),
                volunteerId: volunteer.id,
                action: action,
                points: points,
                reason: reason,
                admin: currentUser.name,
                timestamp: new Date().toISOString()
            });
            
            saveData();
            
            // 重置表单
            document.getElementById('pointAmount').value = '10';
            document.getElementById('pointReason').value = '';
            
            alert('积分调整成功');
            loadPointLogTable();
            updateDashboardStats();
        }
        
        // 加载积分日志表格
        function loadPointLogTable() {
            const logList = document.getElementById('pointLogList');
            logList.innerHTML = '';
            
            const volunteerId = parseInt(document.getElementById('logVolunteer').value) || null;
            
            let filteredLogs = [...systemData.pointLogs];
            if (volunteerId) {
                filteredLogs = filteredLogs.filter(log => log.volunteerId === volunteerId);
            }
            
            // 按时间倒序排序
            filteredLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            filteredLogs.forEach(log => {
                const volunteer = systemData.volunteers.find(v => v.id === log.volunteerId);
                const volunteerName = volunteer ? volunteer.name : '未知';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(log.timestamp).toLocaleString()}</td>
                    <td>${volunteerName}</td>
                    <td>${log.action === 'add' ? '增加' : '扣除'}</td>
                    <td style="color:${log.action === 'add' ? 'green' : 'red'}">${log.action === 'add' ? '+' : '-'}${log.points}</td>
                    <td>${log.reason}</td>
                    <td>${log.admin}</td>
                `;
                logList.appendChild(row);
            });
        }
        
        // 加载积分排行榜
        function loadRanking() {
            const rankingList = document.getElementById('rankingList');
            rankingList.innerHTML = '';
            
            // 创建志愿者副本并排序
            const sortedVolunteers = [...systemData.volunteers]
                .filter(v => !v.isAdmin) // 排除管理员
                .sort((a, b) => b.points - a.points);
            
            sortedVolunteers.forEach((volunteer, index) => {
                const projectsCount = systemData.projects.reduce((count, project) => {
                    return count + (project.participants.some(p => p.volunteerId === volunteer.id) ? 1 : 0);
                }, 0);
                
                const activitiesCount = systemData.activities.reduce((count, activity) => {
                    return count + (activity.participants.some(p => p.volunteerId === volunteer.id) ? 1 : 0);
                }, 0);
                
                const row = document.createElement('tr');
                row.className = `rank-${index + 1}`;
                row.innerHTML = `
                    <td><span class="rank-badge">${index + 1}</span></td>
                    <td>${volunteer.name}</td>
                    <td><strong>${volunteer.points}</strong></td>
                    <td>${projectsCount}</td>
                    <td>${activitiesCount}</td>
                `;
                rankingList.appendChild(row);
            });
        }
        
        // 加载仪表板日志
        function loadPointLogs() {
            const logsContainer = document.getElementById('pointLogs');
            logsContainer.innerHTML = '';
            
            // 获取最近的5条日志
            const recentLogs = [...systemData.pointLogs]
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 5);
            
            recentLogs.forEach(log => {
                const volunteer = systemData.volunteers.find(v => v.id === log.volunteerId);
                const volunteerName = volunteer ? volunteer.name : '未知';
                
                const logItem = document.createElement('div');
                logItem.className = 'log-item';
                logItem.style.padding = '10px';
                logItem.style.borderBottom = '1px solid #eee';
                logItem.innerHTML = `
                    <div style="display:flex; justify-content:space-between;">
                        <div><strong>${volunteerName}</strong></div>
                        <div style="color:${log.action === 'add' ? 'green' : 'red'}">
                            ${log.action === 'add' ? '+' : '-'}${log.points}分
                        </div>
                    </div>
                    <div style="color:#666; font-size:0.9em; margin-top:5px;">${log.reason}</div>
                    <div style="color:#999; font-size:0.8em; text-align:right; margin-top:5px;">
                        ${new Date(log.timestamp).toLocaleDateString()}
                    </div>
                `;
                logsContainer.appendChild(logItem);
            });
        }
        
        // 加载仪表板
        function loadDashboard() {
            updateDashboardStats();
            loadPointLogs();
            loadUserStats();
        }
        
        // 导出数据
        function exportData(type) {
            let data = [];
            let fileName = '';
            
            switch (type) {
                case 'volunteers':
                    data = systemData.volunteers.filter(v => !v.isAdmin);
                    fileName = '志愿者数据.xlsx';
                    break;
                case 'projects':
                    data = systemData.projects;
                    fileName = '志愿项目数据.xlsx';
                    break;
                case 'activities':
                    data = systemData.activities;
                    fileName = '社区活动数据.xlsx';
                    break;
                case 'points':
                    data = systemData.pointLogs;
                    fileName = '积分日志数据.xlsx';
                    break;
            }
            
            if (data.length === 0) {
                alert('没有可导出的数据');
                return;
            }
            
            // 创建工作簿
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
            
            // 导出文件
            XLSX.writeFile(wb, fileName);
            alert(`数据已导出为 ${fileName}`);
        }
        
        // 导入数据
        function importData() {
            const fileInput = document.getElementById('importFile');
            const type = document.getElementById('importType').value;
            
            if (!fileInput.files.length) {
                alert('请选择要导入的文件');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (jsonData.length === 0) {
                        alert('文件中没有数据');
                        return;
                    }
                    
                    // 根据类型导入数据
                    switch (type) {
                        case 'volunteers':
                            systemData.volunteers = [
                                ...systemData.volunteers.filter(v => v.isAdmin), // 保留管理员
                                ...jsonData
                            ];
                            break;
                        case 'projects':
                            systemData.projects = jsonData;
                            break;
                        case 'activities':
                            systemData.activities = jsonData;
                            break;
                        case 'points':
                            systemData.pointLogs = jsonData;
                            break;
                    }
                    
                    saveData();
                    alert(`成功导入 ${jsonData.length} 条数据`);
                    
                    // 刷新当前页面
                    const currentPage = document.querySelector('.page.active').id;
                    showPage(currentPage);
                    
                } catch (error) {
                    console.error('导入失败:', error);
                    alert('导入失败，请检查文件格式');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // 退出登录
        function logout() {
            currentUser = null;
            document.getElementById('app').style.display = 'none';
            document.getElementById('loginPage').style.display = 'block';
        }
    </script>
</body>
</html>